#!/bin/sh

if [ $# -ne 0 ] ; then
  DOCDIRS="$*"
elif [ -f wrapper.tex ]; then
  DOCDIRS="."
elif [ -f docdirs ]; then
  DOCDIRS=`cat docdirs`
else
  DOCDIRS=""
fi

origTEXINPUTS=$TEXINPUTS

TEXINPUTS=../../examples/:../../demo:$TEXINPUTS
for DIR in $DOCDIRS; do
   TEXINPUTS=$DIR:$TEXINPUTS
   if [ -f $DIR/docdirs_passed_tex ] ; then
      DOC_SUBDIRS=`cat $DIR/docdirs_passed_tex`
   elif [ -f $DIR/docdirs ] ; then
      DOC_SUBDIRS=`cat $DIR/docdirs`
   else
      DOC_SUBDIRS=""
   fi
   IONLY="\includeonly{"
   for SUBDIR in ${DOC_SUBDIRS}; do
      TEXINPUTS=${SUBDIR}:${SUBDIR}_ref:$TEXINPUTS
      IONLY="$IONLY,${SUBDIR}/main,${SUBDIR}_ref/main"
   done
   IONLY="$IONLY}"

   echo $IONLY > $DIR/ionly
   export TEXINPUTS
   cd $DIR
   echo "now in directory $DIR..."
   latex wrapper
   echo "...leaving directory $DIR"
   cd ..
done

TEXINPUTS=$origTEXINPUTS
export TEXINPUTS
